#!/bin/bash

set -o errexit -o pipefail

curl()
{
	command curl --location --silent --show-error "$@"
}

dir=/opt/chapel
rm -rf $dir
mkdir -p $dir/build

curl "$(curl https://api.github.com/repos/chapel-lang/chapel/releases \
	| jq --raw-output 'max_by(.published_at)|.tarball_url' \
	| tee /dev/stderr
)" | tar xz --directory=$dir/build --strip-components=1

cd $dir/build
export CHPL_TARGET_ARCH=native CHPL_COMM=gasnet
./configure --prefix=/opt/chapel
make
export CHPL_COMM=none
./configure --prefix=/opt/chapel
make install
cd ..
rm -rf build
